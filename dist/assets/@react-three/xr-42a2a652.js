import{r as a,u as z,a as D,d as j}from"./fiber-426da065.js";import{_ as A,ak as B}from"../three-de3e021a.js";class G extends A{constructor(e,s){super(),this.index=e,this.controller=s.xr.getController(e),this.grip=s.xr.getControllerGrip(e),this.hand=s.xr.getHand(e),this.grip.userData.name="grip",this.controller.userData.name="controller",this.hand.userData.name="hand",this.visible=!1,this.add(this.controller,this.grip,this.hand),this._onConnected=this._onConnected.bind(this),this._onDisconnected=this._onDisconnected.bind(this),this.controller.addEventListener("connected",this._onConnected),this.controller.addEventListener("disconnected",this._onDisconnected)}_onConnected(e){e.fake||(this.visible=!0,this.inputSource=e.data,this.dispatchEvent(e))}_onDisconnected(e){e.fake||(this.visible=!1,this.dispatchEvent(e))}dispose(){this.controller.removeEventListener("connected",this._onConnected),this.controller.removeEventListener("disconnected",this._onDisconnected)}}var X,F;const T=o=>Array.from(new Set(o)),_=typeof window<"u"&&((X=window.document)!=null&&X.createElement||((F=window.navigator)==null?void 0:F.product)==="ReactNative")?a.useLayoutEffect:a.useEffect;function L(o){const e=a.useRef(o);return _(()=>void(e.current=o),[o]),e}function C(o,e,{handedness:s}={}){const f=L(e),u=y(c=>c.controllers);_(()=>{const c=u.map(r=>{if(s&&r.inputSource.handedness!==s)return;const n=p=>f.current({nativeEvent:p,target:r});return r.controller.addEventListener(o,n),()=>r.controller.removeEventListener(o,n)});return()=>c.forEach(r=>r==null?void 0:r())},[u,s,o])}const H=new B;function V({children:o}){const e=z(t=>t.events),s=z(t=>t.get),f=z(t=>t.raycaster),u=y(t=>t.controllers),c=y(t=>t.interactions),r=y(t=>t.hoverState),n=y(t=>t.hasInteraction),p=y(t=>t.getInteraction),S=a.useCallback(t=>{const d=Array.from(c.keys());return H.identity().extractRotation(t.matrixWorld),f.ray.origin.setFromMatrixPosition(t.matrixWorld),f.ray.direction.set(0,0,-1).applyMatrix4(H),f.intersectObjects(d,!0)},[c,f]);D(()=>{if(c.size!==0)for(const t of u){const d=r[t.inputSource.handedness],b=new Set;let l=S(t.controller);if(e.filter)l=e.filter(l,s());else{const h=l.find(v=>v==null?void 0:v.object);h&&(l=[h])}for(const h of l){let v=h.object;for(;v;){if(n(v,"onHover")&&!d.has(v)){const i=p(v,"onHover");for(const x of i)x({target:t,intersection:h,intersections:l})}const E=p(v,"onMove");E==null||E.forEach(i=>i({target:t,intersection:h,intersections:l})),d.set(v,h),b.add(v.id),v=v.parent}}for(const h of d.keys())if(!b.has(h.id)){d.delete(h);const v=p(h,"onBlur");if(!v)continue;for(const E of v)E({target:t,intersections:l})}}});const g=a.useCallback(t=>d=>{const b=r[d.target.inputSource.handedness],l=Array.from(new Set(b.values()));c.forEach((h,v)=>{var E,i,x;if(b.has(v)){if(!h[t])return;for(const m of h[t])(E=m.current)==null||E.call(m,{target:d.target,intersection:b.get(v),intersections:l})}else if(t==="onSelect"&&h.onSelectMissed)for(const m of h.onSelectMissed)(i=m.current)==null||i.call(m,{target:d.target,intersections:l});else if(t==="onSqueeze"&&h.onSqueezeMissed)for(const m of h.onSqueezeMissed)(x=m.current)==null||x.call(m,{target:d.target,intersections:l})})},[r,c]);return C("select",g("onSelect")),C("selectstart",g("onSelectStart")),C("selectend",g("onSelectEnd")),C("squeeze",g("onSqueeze")),C("squeezeend",g("onSqueezeEnd")),C("squeezestart",g("onSqueezeStart")),a.createElement(a.Fragment,null,o)}function R(o,e,s){const f=y(r=>r.addInteraction),u=y(r=>r.removeInteraction),c=L(s);_(()=>{const r=o.current;if(!(!r||!c.current))return f(r,e,c),()=>u(r,e,c)},[o,e,f,u])}const N=a.forwardRef(function({onHover:e,onBlur:s,onSelectStart:f,onSelectEnd:u,onSelectMissed:c,onSelect:r,onSqueezeStart:n,onSqueezeEnd:p,onSqueezeMissed:S,onSqueeze:g,onMove:t,children:d},b){const l=a.useRef(null);return a.useImperativeHandle(b,()=>l.current),R(l,"onHover",e),R(l,"onBlur",s),R(l,"onSelectStart",f),R(l,"onSelectEnd",u),R(l,"onSelectMissed",c),R(l,"onSelect",r),R(l,"onSqueezeStart",n),R(l,"onSqueezeEnd",p),R(l,"onSqueezeMissed",S),R(l,"onSqueeze",g),R(l,"onMove",t),a.createElement("group",{ref:l},d)});a.forwardRef(function({onSelectStart:e,onSelectEnd:s,children:f,...u},c){const r=a.useRef(),n=a.useRef(null),p=a.useMemo(()=>new B,[]);return a.useImperativeHandle(c,()=>n.current),D(()=>{const S=r.current,g=n.current;S&&(g.applyMatrix4(p),g.applyMatrix4(S.matrixWorld),g.updateMatrixWorld(),p.copy(S.matrixWorld).invert())}),a.createElement(N,{ref:n,onSelectStart:S=>{r.current=S.target.controller,p.copy(S.target.controller.matrixWorld).invert(),e==null||e(S)},onSelectEnd:S=>{S.target.controller===r.current&&(r.current=void 0),s==null||s(S)},...u},f)});const W=a.createContext(null),I=j((o,e)=>({set:o,get:e,session:null,referenceSpaceType:null}));function J({foveation:o=0,referenceSpace:e="local-floor",onSessionStart:s,onSessionEnd:f,onVisibilityChange:u,onInputSourcesChange:c,children:r}){const n=z(i=>i.gl),p=z(i=>i.camera),S=y(i=>i.player),g=y(i=>i.get),t=y(i=>i.set),d=y(i=>i.session),b=y(i=>i.controllers),l=L(s),h=L(f),v=L(u),E=L(c);return _(()=>{const i=[0,1].map(x=>{const m=new G(x,n),q=()=>t(w=>({controllers:[...w.controllers,m]})),M=()=>t(w=>({controllers:w.controllers.filter(k=>k!==m)}));return m.addEventListener("connected",q),m.addEventListener("disconnected",M),()=>{m.removeEventListener("connected",q),m.removeEventListener("disconnected",M)}});return()=>i.forEach(x=>x())},[n,t]),_(()=>I.subscribe(({session:i})=>t(()=>({session:i}))),[n.xr,t]),_(()=>{n.xr.setFoveation(o),t(()=>({foveation:o}))},[n.xr,o,t]),_(()=>{const i=I.getState();n.xr.setReferenceSpaceType(e),t(()=>({referenceSpace:e})),i.set({referenceSpaceType:e})},[n.xr,e,t]),_(()=>{if(!d)return void n.xr.setSession(null);const i=M=>{var w;t(()=>({isPresenting:!0})),(w=l.current)==null||w.call(l,{nativeEvent:{...M,target:d},target:d})},x=M=>{var w;t(()=>({isPresenting:!1,session:null})),I.setState(()=>({session:null})),(w=h.current)==null||w.call(h,{nativeEvent:{...M,target:d},target:d})},m=M=>{var w;(w=v.current)==null||w.call(v,{nativeEvent:M,target:d})},q=M=>{var w;const k=Object.values(d.inputSources).some($=>$.hand);t(()=>({isHandTracking:k})),(w=E.current)==null||w.call(E,{nativeEvent:M,target:d})};return n.xr.addEventListener("sessionstart",i),n.xr.addEventListener("sessionend",x),d.addEventListener("visibilitychange",m),d.addEventListener("inputsourceschange",q),n.xr.setSession(d).then(()=>{n.xr.setFoveation(g().foveation)}),()=>{n.xr.removeEventListener("sessionstart",i),n.xr.removeEventListener("sessionend",x),d.removeEventListener("visibilitychange",m),d.removeEventListener("inputsourceschange",q)}},[d,n.xr,t,g]),a.createElement(V,null,a.createElement("primitive",{object:S},a.createElement("primitive",{object:p}),b.map(i=>a.createElement("primitive",{key:i.index,object:i}))),r)}function Y(o){const e=a.useMemo(()=>j((s,f)=>({set:s,get:f,controllers:[],isPresenting:!1,isHandTracking:!1,player:new A,session:null,foveation:0,referenceSpace:"local-floor",hoverState:{left:new Map,right:new Map,none:new Map},interactions:new Map,hasInteraction(u,c){var r;return!!((r=f().interactions.get(u))!=null&&r[c].some(n=>n.current))},getInteraction(u,c){var r;return(r=f().interactions.get(u))==null?void 0:r[c].reduce((n,p)=>(p.current&&n.push(p.current),n),[])},addInteraction(u,c,r){const n=f().interactions;n.has(u)||n.set(u,{onHover:[],onBlur:[],onSelect:[],onSelectEnd:[],onSelectStart:[],onSelectMissed:[],onSqueeze:[],onSqueezeEnd:[],onSqueezeStart:[],onSqueezeMissed:[],onMove:[]}),n.get(u)[c].push(r)},removeInteraction(u,c,r){const n=f().interactions.get(u);if(n){const p=n[c].indexOf(r);p!==-1&&n[c].splice(p,1)}}})),[]);return a.createElement(W.Provider,{value:e},a.createElement(J,{...o}))}const K=(o,e)=>{var s;if(!(!o&&!e))return o&&!e?{optionalFeatures:[o]}:o&&e?{...e,optionalFeatures:T([...(s=e.optionalFeatures)!=null?s:[],o])}:e},O=a.forwardRef(function({mode:e,sessionInit:s,enterOnly:f=!1,exitOnly:u=!1,onClick:c,onError:r,children:n,...p},S){const[g,t]=a.useState("exited"),d=g==="unsupported"?`${e} unsupported`:`${g==="entered"?"Exit":"Enter"} ${e}`,b=e==="inline"?e:`immersive-${e.toLowerCase()}`,l=L(r);_(()=>{if(!(navigator!=null&&navigator.xr))return void t("unsupported");navigator.xr.isSessionSupported(b).then(v=>t(v?"exited":"unsupported"))},[b]),_(()=>I.subscribe(v=>{v.session?t("entered"):g!=="unsupported"&&t("exited")}),[g]);const h=a.useCallback(async v=>{c==null||c(v);const E=I.getState();if(E.session&&f||!E.session&&u)return;let i=null;try{if(E.session)await E.session.end();else{const x=K(E.referenceSpaceType,s);i=await navigator.xr.requestSession(b,x)}E.set(()=>({session:i}))}catch(x){const m=l.current;if(m&&x instanceof Error)m(x);else throw x}},[c,f,u,b,s,l]);return a.createElement("button",{...p,ref:S,onClick:g==="unsupported"?c:h},typeof n=="function"?n(g):n??d)}),P={position:"absolute",bottom:"24px",left:"50%",transform:"translateX(-50%)",padding:"12px 24px",border:"1px solid white",borderRadius:"4px",background:"rgba(0, 0, 0, 0.1)",color:"white",font:"normal 0.8125rem sans-serif",outline:"none",zIndex:99999,cursor:"pointer"},Z=a.forwardRef(({style:o=P,sessionInit:e={domOverlay:typeof document<"u"?{root:document.body}:void 0,optionalFeatures:["hit-test","dom-overlay","dom-overlay-for-handheld-ar"]},children:s,...f},u)=>a.createElement(O,{...f,ref:u,mode:"AR",style:o,sessionInit:e},s));a.forwardRef(({style:o=P,sessionInit:e={optionalFeatures:["local-floor","bounded-floor","hand-tracking","layers"]},children:s,...f},u)=>a.createElement(O,{...f,ref:u,mode:"VR",style:o,sessionInit:e},s));function y(o=s=>s,e){const s=a.useContext(W);if(!s)throw new Error("useXR must be used within an <XR /> component!");return s(o,e)}export{Z as A,Y as X};
